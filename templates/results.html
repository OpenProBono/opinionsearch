<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>OPB - Search Results</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
</head>
<body>
    <h1>Search Results</h1>
    {% for i in range(opinions | length) %}
        <div style="width: 100%; border: 1px solid #737373; padding: 10px;">
            <h3>{{i + 1}}. {{opinions[i].case_name}}</h3>
            <p><i>Match score</i>: {{opinions[i].match_score}}</p>
            <p><b>Court</b>: {{opinions[i].court_name}}</p>
            <p><b>Author</b>: {{opinions[i].author_name}}</p>
            <p><b>Date filed</b>: {{opinions[i].date_filed}}</p>
            {% if opinions[i].ai_summary != "unavailable" %}
                <p class="summary-{{ opinions[i].opinion_id }}"><b>AI summary</b>: {{ opinions[i].ai_summary }}</p>
            {% else %}
                <div style="display:flex;">
                    <p><b>AI summary</b>:</p>
                    <div style="display:none" class="spinner-border loading-{{ opinions[i].opinion_id }}" role="status">
                        <span class="sr-only">Loading...</span>
                    </div>
                    <button class="fetch-{{ opinions[i].opinion_id }}" onclick="fetchSummary('{{ opinions[i].opinion_id }}')">
                        Summarize this opinion
                    </button>
                </div>
            {% endif %}
            {% if opinions[i].url == "unavailable" %}
                <p><b>Full text link</b>: Full text unavilable</p>
            {% else %}
                <p><b>Full text link</b>: <a href="{{ opinions[i].url }}">{{ opinions[i].url }}</a></p>
            {% endif %}
            <p><b>Matched excerpt</b>: </p>
            <div style="border: 1px solid #737373; overflow-y: scroll; max-height: 300px;">{{opinions[i].text | safe }}</div>
        </div>
    {% endfor %}
    <script>
        async function fetchSummary(opinionId) {
            const fetchButtons = document.getElementsByClassName("fetch-" + opinionId);
            const loadingIcons = document.getElementsByClassName("loading-" + opinionId);
            const summaryTexts = document.getElementsByClassName("summary-" + opinionId);
            // hide button, show loading animation
            for (let i = 0; i < fetchButtons.length; i++) {
                fetchButtons[i].style.display = "none";
                loadingIcons[i].style.display = "block";
            }
            // make request
            // var xhr = new XMLHttpRequest();
            // xhr.open('GET', '/summary/' + opinionId, true);
            // xhr.onload = function() {
            //     if (xhr.status === 200) {
            //         for (let i = 0; i < fetchButtons.length; i++) {
            //             console.log(i);
            //             // hide animation
            //             loadingIcons[i].style.display = "none";
            //             // Update the summary text with the received data
            //             summaryTexts[i].innerHTML = "<b>AI summary</b>: " + xhr.responseText;
            //         }
            //     } else {
            //         console.error('Error fetching summary from Flask:', xhr.statusText);
            //         // hide animation, show button
            //         for (let i = 0; i < fetchButtons.length; i++) {
            //             fetchButtons[i].style.display = "block";
            //             loadingIcons[i].style.display = "none";
            //         }
            //     }
            // };
            // xhr.send();
            await new Promise(r => setTimeout(r, 2000));
            for (let i = 0; i < fetchButtons.length; i++) {
                console.log(i);
                // hide animation
                loadingIcons[i].style.display = "none";
                // Update the summary text with the received data
                summaryTexts[i].innerHTML = "<b>AI summary</b>: " + "foo";
            }
        }
    </script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz" crossorigin="anonymous"></script>
</body>
</html>